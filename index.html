<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/layout.css">
</head>
<body>
<!-- 布局部分 -->
<div class="jumbotron">
	<div class="container">
		<h1>欢迎来到美丫图床</h1>
		<p>美丫图床为大家带来各种炫酷的表情哦</p>
		<!-- <p><a class="btn btn-primary btn-lg" role="button">广告君的地盘</a></p> -->
	</div>
</div>
<div class="wrap">
	<div id="main"></div>
</div>

<div class="inputDiv">
	<input type="file" multiple="true" id="uploads">
</div>

<!-- js代码部分 -->
<script src="js/jquery.min.js"></script>
<script src="js/jquery.lazyload.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/up.itorr.js"></script>
<script src="js/waterfall.js"></script>
<script>
$(function () {

	// 页面图片数据初始化
	$.ajax({
		type: 'GET',
		url: 'admin/getPics.php',
		dataType: 'json',
		success: function (json) {
			if(json.status) {
				var content = '';
				json.data.forEach(function (obj) {
					content += '<div class="box" id="'
					+ obj.id +'"><div class="pic"><img src="http://ww2.sinaimg.cn/large/'
					+ obj.pid
					+ '" /></div></div>'
				});
				$('#main').html(content);
				waterfall('main', 'box');
			} else {
				$('#main').html('还木有图片哟~');
			}
		}
	});

	// 开启所有图片懒加载
	$('img').lazyload();

	// 监测上传框数据变化，有则执行上传图片处理
	$('#uploads').change(function () {

		// 如果上传框里没有数据则返回
		if (!this.files || !this.files[0]) {
			return alert('选取文件出错！');
		}

		// 上传了多少张图片就在main里添加多少个空的div
		for (var i = 0, len = this.files.length; i < len; i ++) {
			var node = '<div class="box" id="box'
			+ i + '"><div class="pic progress">0%</div></div>';
			$('#main').prepend(node);
		}

		// 对所有图片进行依次上传
		for (var i = 0, len = this.files.length; i < len; i ++) {
			var picfile = this.files[i];

			// 监测上传的文件是不是图片
			if (picfile.type.indexOf('image') != 0) {
				return alert('这不是一个图像呀！');
			}

			// 将图片上传到微博服务器，并返回图片唯一的pid
			upPic(picfile, function (pid) {
				var postData = JSON.stringify({'pid': pid});

				// 将返回的pid存储到数据库
				$.ajax({
					type: 'POST',
					url: 'admin/save.php',
					data: postData,
					dataType: 'json',
					success: function (json) {
						alert(JSON.stringify(json));
					}
				});
			}, function () {
				alert('上传文件出错了！');
			}, function (progress) {
				$('.progress').last().html(parseInt(progress * 100) + '%');
			})
		}
	});
})
</script>

</body>
</html>